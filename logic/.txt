graph TD
    %% User Actions
    User([User])
    User -->|Uploads Receipt Photo| API
    User -->|Asks: What's for dinner?| API

    %% API Gateway
    API[API Gateway / BFF]

    %% =====================
    %% RECEIPT PIPELINE (ASYNC)
    %% =====================
    subgraph Receipt_Pipeline [Receipt Processing - Async]
        API -->|Store Image| Storage[(Object Storage)]
        API -->|Emit Event| Queue[Receipt Queue]

        Queue --> OCR[Vision OCR Service]
        OCR -->|Raw Line Items + Confidence| Normalize

        Normalize[Item Normalization Service]
        Normalize -->|High Confidence| PantrySvc
        Normalize -->|Low Confidence| Search

        Search[Web Search / Product Catalog]
        Search --> Normalize

        PantrySvc[Pantry Service]
        PantrySvc --> DB[(Pantry Database)]
    end

    %% =====================
    %% MEAL PLANNING (SYNC)
    %% =====================
    subgraph Meal_Planning [Meal Planning - Sync]
        API --> Context[Context Builder]
        Context -->|Time of Day| RuleTime[Time Filter]
        Context -->|Inventory Snapshot| RuleInventory[Inventory Filter]
        Context -->|User Preferences| RuleProfile[Preference Filter]

        RuleTime --> Candidates
        RuleInventory --> Candidates
        RuleProfile --> Candidates

        Candidates --> LLM[Recipe Reasoning LLM]
        LLM --> Recipes[Top 3 Recipes + Rationale]
    end

    %% =====================
    %% CONTENT ENRICHMENT
    %% =====================
    subgraph Presentation [Content Enrichment]
        Recipes --> YT[YouTube Search API]
        Recipes --> Missing[Missing Ingredients Diff]
        YT --> Video[Recipe Video Links]
        Video --> UI
        Missing --> UI
    end

    UI[User Interface]
